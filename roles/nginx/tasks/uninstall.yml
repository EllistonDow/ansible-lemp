---
# Enhanced nginx uninstall script for both package and source installations
- name: Stop nginx service
  systemd:
    name: nginx
    state: stopped
    enabled: no
  ignore_errors: yes

- name: Check if nginx is source-compiled
  stat:
    path: /usr/local/src/nginx-1.29.1
  register: source_nginx

- name: Check current nginx version
  command: /usr/sbin/nginx -V
  register: nginx_version_check
  ignore_errors: yes

- name: Display current nginx installation type
  debug:
    msg: |
      {% if source_nginx.stat.exists %}
      ğŸ” æ£€æµ‹åˆ°æºç ç¼–è¯‘çš„nginxå®‰è£…
      {% if nginx_version_check.rc == 0 %}
      å½“å‰ç‰ˆæœ¬: {{ nginx_version_check.stderr.split('\n')[0] }}
      ç¼–è¯‘å‚æ•°: {{ nginx_version_check.stderr.split('\n')[3:] | join(' ') }}
      {% endif %}
      {% else %}
      ğŸ” æ£€æµ‹åˆ°åŒ…ç®¡ç†å™¨å®‰è£…çš„nginx
      {% endif %}

# Remove source-compiled nginx files
- name: Remove source-compiled nginx binary
  file:
    path: /usr/sbin/nginx
    state: absent
  when: source_nginx.stat.exists

- name: Remove source-compiled nginx systemd service
  file:
    path: /etc/systemd/system/nginx.service
    state: absent
  when: source_nginx.stat.exists

- name: Remove all nginx source build directories and files
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - /usr/local/src/nginx-1.29.1
    - /usr/local/src/nginx-1.29.1.tar.gz
    - /usr/local/src/nginx-1.28.0
    - /usr/local/src/nginx-1.28.0.tar.gz
    - /usr/local/src/nginx-1.28.0.tar.gz.1
    - /usr/local/src/nginx-1.28.0.tar.gz.2
    - /usr/local/src/nginx-1.28.0.tar.gz.3
    - /usr/local/src/nginx-1.28.0.tar.gz.4
    - /usr/local/src/nginx-1.28.0.tar.gz.5
    - /usr/local/src/nginx-1.28.0.tar.gz.6
    - /usr/local/src/ModSecurity-nginx
  ignore_errors: yes

# Remove package-installed nginx (including debug version)
- name: Remove nginx packages
  apt:
    name:
      - nginx
      - nginx-common
      - nginx-core
      - nginx-full
      - nginx-light
      - nginx-extras
      - libmodsecurity3
      - modsecurity-crs
    state: absent
    purge: yes
  ignore_errors: yes

- name: Remove nginx debug binary
  file:
    path: /usr/sbin/nginx-debug
    state: absent

- name: Remove custom nginx test script
  file:
    path: /usr/local/bin/nginx-test
    state: absent

# Remove shared nginx files and directories
- name: Remove nginx configuration directory
  file:
    path: /etc/nginx
    state: absent

- name: Remove nginx log directory
  file:
    path: /var/log/nginx
    state: absent

- name: Remove nginx cache directory
  file:
    path: /var/cache/nginx
    state: absent

- name: Remove nginx runtime directory files
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - /run/nginx.pid
    - /run/nginx.lock
  ignore_errors: yes

- name: Remove ModSecurity configuration
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - /etc/modsecurity
    - /etc/nginx/modsec
  ignore_errors: yes

- name: Remove nginx repository
  apt_repository:
    repo: "deb https://nginx.org/packages/ubuntu {{ ansible_distribution_release }} nginx"
    state: absent
  ignore_errors: yes

- name: Remove systemd helper files
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - /var/lib/systemd/deb-systemd-helper-enabled/multi-user.target.wants/nginx.service
    - /var/lib/systemd/deb-systemd-helper-enabled/nginx-debug.service.dsh-also
    - /var/lib/systemd/deb-systemd-helper-enabled/nginx.service.dsh-also
    - /etc/systemd/system/nginx.service.d
  ignore_errors: yes

- name: Reload systemd daemon after service removal
  systemd:
    daemon_reload: yes

- name: Clean package manager cache
  apt:
    autoclean: yes
    autoremove: yes

- name: Clean up any remaining nginx processes
  shell: |
    pkill nginx || true
    killall nginx || true
  ignore_errors: yes

- name: Verify nginx removal
  shell: |
    if command -v nginx >/dev/null 2>&1; then
      echo "WARNING: nginx binary still exists at $(which nginx)"
      exit 1
    else
      echo "SUCCESS: nginx completely removed"
      exit 0
    fi
  register: removal_check
  ignore_errors: yes

- name: Display uninstall completion message
  debug:
    msg: |
      ğŸ¯ Nginxå¸è½½å®ŒæˆçŠ¶æ€ï¼š
      
      {% if removal_check.rc == 0 %}
      âœ… Nginxå·²å®Œå…¨å¸è½½æˆåŠŸ
      
      ğŸ“‹ å·²æ¸…ç†çš„å†…å®¹ï¼š
      {% if source_nginx.stat.exists %}
      - æºç ç¼–è¯‘çš„nginx 1.29.1äºŒè¿›åˆ¶æ–‡ä»¶
      - æºç æ„å»ºç›®å½• (/usr/local/src/nginx-*)
      - ModSecurityæºç ç›®å½•
      - è‡ªå®šä¹‰systemdæœåŠ¡æ–‡ä»¶
      {% endif %}
      - åŒ…ç®¡ç†å™¨å®‰è£…çš„nginxåŒ…
      - é…ç½®ç›®å½• (/etc/nginx)
      - æ—¥å¿—ç›®å½• (/var/log/nginx)
      - ç¼“å­˜ç›®å½• (/var/cache/nginx)
      - ModSecurityé…ç½®æ–‡ä»¶
      - è¿è¡Œæ—¶æ–‡ä»¶ (pid, lock)
      
      ğŸ”„ ä¸‹ä¸€æ­¥ï¼š
      - é‡å¯ç³»ç»Ÿä»¥ç¡®ä¿å®Œå…¨æ¸…ç†: sudo reboot
      - æˆ–é‡æ–°å®‰è£…nginx: ansible-playbook playbooks/nginx.yml
      {% else %}
      âš ï¸  è­¦å‘Šï¼š{{ removal_check.stdout }}
      
      ğŸ› ï¸  æ‰‹åŠ¨æ¸…ç†å»ºè®®ï¼š
      - æ£€æŸ¥å‰©ä½™æ–‡ä»¶: sudo find / -name "*nginx*" 2>/dev/null
      - å¼ºåˆ¶åˆ é™¤äºŒè¿›åˆ¶: sudo rm -f $(which nginx)
      - æ¸…ç†PATHç¼“å­˜: hash -r
      {% endif %}
