---
- name: Update apt cache
  apt:
    update_cache: yes

- name: Install dependencies
  apt:
    name:
      - curl
      - gnupg2
      - ca-certificates
      - lsb-release
      - net-tools
    state: present

- name: Add nginx signing key
  apt_key:
    url: https://nginx.org/keys/nginx_signing.key
    state: present

- name: Add nginx repository
  apt_repository:
    repo: "deb https://nginx.org/packages/ubuntu {{ ansible_distribution_release }} nginx"
    state: present

- name: Install nginx from official repository
  apt:
    name: nginx
    state: present
    update_cache: yes

- name: Install ModSecurity build dependencies
  apt:
    name:
      - build-essential
      - libtool
      - autoconf
      - git
      - pkg-config
      - libpcre3-dev
      - zlib1g-dev
      - libssl-dev
      - libmodsecurity-dev
      - libmodsecurity3
      - modsecurity-crs
    state: present
  when: modsecurity_enabled | default(false)

- name: Check if ModSecurity nginx module directory exists
  stat:
    path: /usr/local/src/ModSecurity-nginx
  register: modsec_nginx_dir
  when: modsecurity_enabled | default(false)

- name: Clone ModSecurity nginx connector
  git:
    repo: https://github.com/SpiderLabs/ModSecurity-nginx.git
    dest: /usr/local/src/ModSecurity-nginx
    depth: 1
  when: 
    - modsecurity_enabled | default(false)
    - not modsec_nginx_dir.stat.exists

- name: Get nginx version and configure parameters
  shell: nginx -V 2>&1 | grep "configure arguments"
  register: nginx_configure_args
  when: modsecurity_enabled | default(false)

- name: Stop nginx for recompilation
  service:
    name: nginx
    state: stopped
  when: modsecurity_enabled | default(false)

- name: Get nginx source for recompilation
  shell: |
    NGINX_VERSION=$(nginx -v 2>&1 | grep -o '[0-9.]*')
    cd /usr/local/src
    wget -q http://nginx.org/download/nginx-${NGINX_VERSION}.tar.gz
    tar -xzf nginx-${NGINX_VERSION}.tar.gz
    echo "nginx-${NGINX_VERSION}" > /tmp/nginx_version.txt
  when: modsecurity_enabled | default(false)

- name: Read nginx version from file
  slurp:
    src: /tmp/nginx_version.txt
  register: nginx_version_file
  when: modsecurity_enabled | default(false)

- name: Recompile nginx with ModSecurity
  shell: |
    NGINX_DIR="{{ nginx_version_file['content'] | b64decode | trim }}"
    cd "/usr/local/src/${NGINX_DIR}"
    ./configure {{ nginx_configure_args.stdout.split('configure arguments: ')[1] }} --without-pcre2 --with-pcre --add-dynamic-module=/usr/local/src/ModSecurity-nginx
    make modules
    cp objs/ngx_http_modsecurity_module.so /etc/nginx/modules/
  when: modsecurity_enabled | default(false)

- name: Create nginx modules directory if not exists
  file:
    path: /etc/nginx/modules
    state: directory
    owner: root
    group: root
    mode: '0755'
  when: modsecurity_enabled | default(false)

- name: Create ModSecurity configuration directory
  file:
    path: /etc/nginx/modsec
    state: directory
    owner: root
    group: root
    mode: '0755'
  when: modsecurity_enabled | default(false)

- name: Create ModSecurity main configuration
  copy:
    dest: /etc/nginx/modsec/main.conf
    content: |
      # ModSecurity configuration
      Include /etc/modsecurity/modsecurity.conf
      
      # Include OWASP CRS setup
      Include /etc/modsecurity/crs-setup.conf
      
      # Include OWASP CRS rules if available
      Include /etc/modsecurity/rules/*.conf
    owner: root
    group: root
    mode: '0644'
  when: modsecurity_enabled | default(false)

- name: Create ModSecurity configuration
  copy:
    dest: /etc/modsecurity/modsecurity.conf
    content: |
      # ModSecurity configuration
      SecRuleEngine On
      SecRequestBodyAccess On
      SecRequestBodyLimit 13107200
      SecRequestBodyNoFilesLimit 131072
      SecRequestBodyLimitAction Reject
      SecResponseBodyAccess On
      SecResponseBodyMimeType text/plain text/html text/xml
      SecResponseBodyLimit 524288
      SecResponseBodyLimitAction ProcessPartial
      SecTmpDir /tmp/
      SecDataDir /tmp/
      SecAuditEngine RelevantOnly
      SecAuditLogRelevantStatus "^(?:5|4(?!04))"
      SecAuditLogParts ABIJDEFHZ
      SecAuditLogType Serial
      SecAuditLog /var/log/nginx/modsec_audit.log
      
      # Set CRS setup version to avoid initialization errors
      SecAction "id:900990,phase:1,pass,t:none,nolog,setvar:tx.crs_setup_version=335"
    owner: root
    group: root
    mode: '0644'
  when: modsecurity_enabled | default(false)

- name: Setup OWASP CRS rules link
  file:
    src: /usr/share/modsecurity-crs/rules
    dest: /etc/modsecurity/rules
    state: link
    force: yes
  when: modsecurity_enabled | default(false)

- name: Copy CRS setup configuration
  copy:
    src: /etc/modsecurity/crs/crs-setup.conf
    dest: /etc/modsecurity/crs-setup.conf
    remote_src: yes
    owner: root
    group: root
    mode: '0644'
  when: modsecurity_enabled | default(false)

- name: Create systemd override directory for nginx
  file:
    path: /etc/systemd/system/nginx.service.d
    state: directory
    owner: root
    group: root
    mode: '0755'
  when: modsecurity_enabled | default(false)

- name: Create systemd override for PCRE library loading
  copy:
    dest: /etc/systemd/system/nginx.service.d/override.conf
    content: |
      [Service]
      Environment=LD_PRELOAD=/lib/x86_64-linux-gnu/libpcre.so.3
    owner: root
    group: root
    mode: '0644'
  when: modsecurity_enabled | default(false)
  notify: reload systemd

- name: Reload systemd daemon
  systemd:
    daemon_reload: yes
  when: modsecurity_enabled | default(false)

- name: Create nginx test wrapper script for ModSecurity compatibility
  copy:
    content: |
      #!/bin/bash
      # Nginx configuration test wrapper with LD_PRELOAD for ModSecurity compatibility
      export LD_PRELOAD="/lib/x86_64-linux-gnu/libpcre.so.3"
      exec nginx -t "$@"
    dest: /usr/local/bin/nginx-test
    mode: '0755'
    owner: root
    group: root
  when: modsecurity_enabled | default(false)

# PCRE ModSecurity Compatibility Fix Tasks
- name: Install additional PCRE compatibility packages for ModSecurity
  apt:
    name:
      - libpcre3
      - libpcre3-dev
      - libpcrecpp0v5
    state: present
  when: modsecurity_enabled | default(false)

- name: Create ModSecurity PCRE compatibility check script
  copy:
    content: |
      #!/bin/bash
      # ModSecurity PCRE Compatibility Check and Auto-Fix
      set -e
      
      NGINX_CONF="/etc/nginx/nginx.conf"
      LOG_FILE="/var/log/nginx-pcre-fix.log"
      
      echo "$(date): Starting ModSecurity PCRE compatibility check" >> "$LOG_FILE"
      
      # Test nginx configuration for PCRE issues
      if nginx -t 2>&1 | grep -q "undefined symbol: pcre_malloc"; then
          echo "$(date): PCRE compatibility issue detected" >> "$LOG_FILE"
          
          # Create backup
          cp "$NGINX_CONF" "${NGINX_CONF}.pcre_backup_$(date +%Y%m%d_%H%M%S)"
          
          # Temporarily disable ModSecurity to allow nginx to start
          sed -i 's/^load_module modules\/ngx_http_modsecurity_module.so;/#load_module modules\/ngx_http_modsecurity_module.so; # PCRE fix - disabled/' "$NGINX_CONF"
          sed -i 's/^[[:space:]]*modsecurity on;/#    modsecurity on; # PCRE fix - disabled/' "$NGINX_CONF"
          sed -i 's/^[[:space:]]*modsecurity_rules_file/#    modsecurity_rules_file # PCRE fix - disabled/' "$NGINX_CONF"
          
          echo "$(date): ModSecurity temporarily disabled due to PCRE incompatibility" >> "$LOG_FILE"
          
          # Test configuration again
          if nginx -t; then
              echo "$(date): Nginx configuration is now valid" >> "$LOG_FILE"
              exit 0
          else
              echo "$(date): Configuration still has issues" >> "$LOG_FILE"
              exit 1
          fi
      else
          echo "$(date): No PCRE compatibility issues detected" >> "$LOG_FILE"
          exit 0
      fi
    dest: /usr/local/bin/nginx-pcre-fix
    mode: '0755'
    owner: root
    group: root
  when: modsecurity_enabled | default(false)

- name: Create comprehensive ModSecurity PCRE fix script
  copy:
    content: |
      #!/bin/bash
      # Comprehensive ModSecurity PCRE Compatibility Fix Script
      # This script fixes the pcre_malloc undefined symbol error
      
      set -e
      
      # Colors for output
      RED='\033[0;31m'
      GREEN='\033[0;32m'
      YELLOW='\033[1;33m'
      BLUE='\033[0;34m'
      NC='\033[0m'
      
      echo -e "${BLUE}ðŸ”§ ModSecurity PCRE Compatibility Fix${NC}"
      echo "====================================="
      
      # Check if ModSecurity module exists
      if [ ! -f "/etc/nginx/modules/ngx_http_modsecurity_module.so" ]; then
          echo -e "${YELLOW}ModSecurity module not found. Nothing to fix.${NC}"
          exit 0
      fi
      
      # Test for PCRE issue
      echo -e "${BLUE}Testing nginx configuration...${NC}"
      if nginx -t 2>&1 | grep -q "undefined symbol: pcre_malloc"; then
          echo -e "${YELLOW}âš ï¸  PCRE compatibility issue detected!${NC}"
          
          # Backup configuration
          echo -e "${BLUE}Backing up nginx configuration...${NC}"
          cp /etc/nginx/nginx.conf /etc/nginx/nginx.conf.pcre_backup_$(date +%Y%m%d_%H%M%S)
          
          # Attempt recompilation
          echo -e "${BLUE}Attempting to recompile ModSecurity module with proper PCRE support...${NC}"
          
          if [ -d "/usr/local/src/ModSecurity-nginx" ]; then
              cd /usr/local/src/ModSecurity-nginx
              
              # Get nginx version and configure args
              NGINX_VERSION=$(nginx -v 2>&1 | grep -o '[0-9]\+\.[0-9]\+\.[0-9]\+')
              CONFIGURE_ARGS=$(nginx -V 2>&1 | grep "configure arguments" | sed 's/.*configure arguments: //')
              
              # Download nginx source if not exists
              if [ ! -d "/usr/local/src/nginx-${NGINX_VERSION}" ]; then
                  cd /usr/local/src
                  wget -q "http://nginx.org/download/nginx-${NGINX_VERSION}.tar.gz" || {
                      echo -e "${RED}Failed to download nginx source${NC}"
                      exit 1
                  }
                  tar -xzf "nginx-${NGINX_VERSION}.tar.gz"
              fi
              
              # Recompile with proper PCRE settings
              cd "/usr/local/src/nginx-${NGINX_VERSION}"
              
              echo -e "${BLUE}Configuring nginx with PCRE compatibility...${NC}"
              ./configure $CONFIGURE_ARGS \
                  --without-pcre2 \
                  --with-pcre \
                  --with-pcre-jit \
                  --add-dynamic-module=/usr/local/src/ModSecurity-nginx 2>/dev/null || {
                  echo -e "${RED}Configuration failed, falling back to disable ModSecurity${NC}"
                  # Fallback: disable ModSecurity
                  sed -i 's/^load_module modules\/ngx_http_modsecurity_module.so;/#load_module modules\/ngx_http_modsecurity_module.so; # PCRE incompatibility/' /etc/nginx/nginx.conf
                  sed -i 's/^[[:space:]]*modsecurity on;/#    modsecurity on; # PCRE incompatibility/' /etc/nginx/nginx.conf
                  sed -i 's/^[[:space:]]*modsecurity_rules_file/#    modsecurity_rules_file # PCRE incompatibility/' /etc/nginx/nginx.conf
                  exit 0
              }
              
              echo -e "${BLUE}Building ModSecurity module...${NC}"
              make modules 2>/dev/null || {
                  echo -e "${RED}Build failed, disabling ModSecurity${NC}"
                  sed -i 's/^load_module modules\/ngx_http_modsecurity_module.so;/#load_module modules\/ngx_http_modsecurity_module.so; # Build failed/' /etc/nginx/nginx.conf
                  sed -i 's/^[[:space:]]*modsecurity on;/#    modsecurity on; # Build failed/' /etc/nginx/nginx.conf
                  sed -i 's/^[[:space:]]*modsecurity_rules_file/#    modsecurity_rules_file # Build failed/' /etc/nginx/nginx.conf
                  exit 0
              }
              
              # Install new module
              cp objs/ngx_http_modsecurity_module.so /etc/nginx/modules/
              echo -e "${GREEN}âœ… ModSecurity module recompiled successfully${NC}"
              
              # Test configuration
              if nginx -t; then
                  echo -e "${GREEN}âœ… Nginx configuration test passed!${NC}"
                  echo -e "${GREEN}âœ… ModSecurity PCRE compatibility fixed!${NC}"
              else
                  echo -e "${YELLOW}Configuration test still fails, disabling ModSecurity...${NC}"
                  sed -i 's/^load_module modules\/ngx_http_modsecurity_module.so;/#load_module modules\/ngx_http_modsecurity_module.so; # Still incompatible/' /etc/nginx/nginx.conf
                  sed -i 's/^[[:space:]]*modsecurity on;/#    modsecurity on; # Still incompatible/' /etc/nginx/nginx.conf
                  sed -i 's/^[[:space:]]*modsecurity_rules_file/#    modsecurity_rules_file # Still incompatible/' /etc/nginx/nginx.conf
              fi
          else
              echo -e "${RED}ModSecurity source not found, disabling ModSecurity${NC}"
              sed -i 's/^load_module modules\/ngx_http_modsecurity_module.so;/#load_module modules\/ngx_http_modsecurity_module.so; # Source not found/' /etc/nginx/nginx.conf
              sed -i 's/^[[:space:]]*modsecurity on;/#    modsecurity on; # Source not found/' /etc/nginx/nginx.conf
              sed -i 's/^[[:space:]]*modsecurity_rules_file/#    modsecurity_rules_file # Source not found/' /etc/nginx/nginx.conf
          fi
      else
          echo -e "${GREEN}âœ… No PCRE compatibility issues detected${NC}"
      fi
      
      echo -e "${BLUE}PCRE compatibility check completed!${NC}"
    dest: /home/doge/ansible-lemp/scripts/fix-modsecurity-pcre.sh
    mode: '0755'
    owner: root
    group: root
  when: modsecurity_enabled | default(false)

- name: Run ModSecurity PCRE compatibility check
  shell: /usr/local/bin/nginx-pcre-fix
  register: pcre_fix_result
  when: modsecurity_enabled | default(false)
  ignore_errors: yes

- name: Display PCRE compatibility check results
  debug:
    msg: "{{ pcre_fix_result.stdout_lines | default(['No PCRE check output']) }}"
  when: 
    - modsecurity_enabled | default(false)
    - pcre_fix_result is defined

- name: Remove default nginx configuration to prevent conflicts
  file:
    path: /etc/nginx/conf.d/default.conf
    state: absent
  notify: reload nginx

- name: Configure nginx
  template:
    src: nginx.conf.j2
    dest: /etc/nginx/nginx.conf
    backup: yes

- name: Start and enable nginx
  systemd:
    name: nginx
    state: started
    enabled: yes
