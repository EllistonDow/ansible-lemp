# Magento2 Admin 后台优化配置
# 解决菜单点击无响应问题

# Admin区域配置
location ~* ^/(admin|admin_[a-z0-9]+)/ {
    # 禁用FastCGI缓存（后台不需要缓存）
    fastcgi_cache_bypass 1;
    fastcgi_no_cache 1;
    
    # 降低ModSecurity敏感度或禁用（可选）
    # modsecurity off;
    
    # 增加超时时间
    fastcgi_read_timeout 600s;
    fastcgi_send_timeout 600s;
    fastcgi_connect_timeout 60s;
    
    # 增加buffer大小
    fastcgi_buffer_size 128k;
    fastcgi_buffers 8 128k;
    fastcgi_busy_buffers_size 256k;
    
    # PHP处理
    try_files $uri $uri/ /index.php$is_args$args;
    
    location ~ \.php$ {
        fastcgi_pass unix:/run/php/php8.3-fpm.sock;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
        
        # 禁用缓存
        fastcgi_cache_bypass 1;
        fastcgi_no_cache 1;
        
        # 增加超时
        fastcgi_read_timeout 600s;
        fastcgi_send_timeout 600s;
    }
}

# Admin静态文件
location ~* ^/(admin|admin_[a-z0-9]+)/.*\.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
    
    # 尝试静态文件，否则生成
    try_files $uri $uri/ @magento2_admin_static;
}

# Admin静态文件生成
location @magento2_admin_static {
    rewrite ^/(admin|admin_[a-z0-9]+)/(.*)$ /static.php?resource=$2 last;
}

# 禁止访问敏感文件
location ~* ^/(admin|admin_[a-z0-9]+)/.*\.(htaccess|htpasswd|ini|log|sh|sql|conf)$ {
    deny all;
    return 404;
}
